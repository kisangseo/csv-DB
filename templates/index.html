<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BSCO Search Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
</head>
<body>
  
  <div class="container">
    <h1>BCSO Search Portal</h1>

    <form id="searchForm" onsubmit="search(event)">
      <input type="text" id="name" name="name" placeholder="Name">
      <input type="text" id="case_number" name="case_number" placeholder="Case Number">
      <input type="text" id="intake_date" name="intake_date" placeholder="Select Date Range">
      <input type="hidden" id="intake_date_hidden" name="intake_date">
      <button type="submit">Search</button>
      <!-- Advanced Search -->
      <details class="advanced-search" closed>
        <summary>Advanced Search</summary>
      
        

        <div class="advanced-fields">

          <input
            type="text"
            id="sid"
            placeholder="SID"
          />
          <input
            type="text"
            id="dob"
            name="dob"
            placeholder="Date of Birth"
          />

          
          <select id="sex">
            <option value="">Sex (Any)</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>

          <select id="race">
            <option value="">Race (Any)</option>
            <option value="black">Black</option>
            <option value="white">White</option>
            <option value="hispanic">Hispanic</option>
            <option value="asian">Asian</option>
            <option value="other">Other</option>
          </select>

          <input
            type="text"
            id="issuing_county"
            placeholder="Issuing County"
          >

          <input
            type="number"
            id="last_x_days"
            name="last_x_days"
            min="1"
            placeholder="In the last X days"
          >
          
        </div>
      </details>
      
    </form>

    <!-- ðŸ‘‡ Added status message placeholder -->
    <p id="statusMessage"></p>

    <div id="results"></div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script id="fp-script-v2">
      // Helper function to update both visible + hidden fields
      function updateDateFields(selectedDates) {
        const f = d => d.toISOString().slice(0, 10);
        let val = "";

        if (selectedDates.length === 1) {
          const one = f(selectedDates[0]);
          val = `${one} to ${one}`;
        }
        else if (selectedDates.length === 2) {
            val = `${f(selectedDates[0])} to ${f(selectedDates[1])}`;
        }
        else {
            // No dates selected
            val = "";
        }

        // Hidden field -> backend uses this
        document.getElementById("intake_date_hidden").value = val;

        // Visible field -> user sees this
        document.getElementById("intake_date").value = val;
      }
    
    
    
      flatpickr("#intake_date", {
          mode: "range",
          dateFormat: "Y-m-d",
          allowInput: false,
          onChange: function(selectedDates) {
            updateDateFields(selectedDates);
        },

          onClose: function(selectedDates) {
            updateDateFields(selectedDates);
        }
      });
      flatpickr("#dob", {
        dateFormat: "Y-m-d",
        allowInput: true
      });
      
    </script>
      

    <script>
       const FIELD_MAP = {
        "Name": "name",
        "SID": "sid",
        "Case Number": "case_number",
        "Address": "address",
        "Warrant Type": "warrant_type",
        "Issue Date": "record_date",
        "Warrant Status": "warrant_status",
        "Type": "court_document_type",
        
        "Status": "disposition",

        // future-proofing (wonâ€™t be used yet, but safe)
        "Intake Date": "intake_date",
        "Court Document Type": "court_document_type",
        "Current Disposition": "disposition",
        "Defendant Name": "name",
        "Event Date": "record_date",
        "Event Type": "disposition"
      };
      async function search(event) {
        event.preventDefault();

        const status = document.getElementById("statusMessage");
        const resultsDiv = document.getElementById("results");

        // Show loading state
        resultsDiv.innerHTML = "";
        status.textContent = "Searching...";
        status.classList.add("loading");

        // Read date from hidden field (always set by flatpickr)
        let d = document.getElementById("intake_date_hidden").value;

        const params = new URLSearchParams({
          name: document.getElementById("name").value,
          case_number: document.getElementById("case_number").value,
          intake_date: d,
          last_x_days: document.getElementById("last_x_days").value,
          sex: document.getElementById("sex").value,
          race: document.getElementById("race").value,
          issuing_county: document.getElementById("issuing_county").value,
          sid: document.getElementById("sid").value,
          dob: document.getElementById("dob").value
        });
        try {
          const response = await fetch(`${window.location.origin}/search_all?${params}`);
          const data = await response.json();

          status.classList.remove("loading");

          if (Object.keys(data).length === 0) {
            resultsDiv.innerHTML = "<p>No results found.</p>";
            status.textContent = "No results found.";
            return;
          }

          status.textContent = "Search complete.";

          for (const [dept, info] of Object.entries(data)) {
            const rows = info.records;
            const count = info.count;

            const div = document.createElement("div");
            div.className = "department";

            const title = document.createElement("h2");
            if (dept.toUpperCase() === "FSDW") {
              title.textContent = "Warrant of Restitution";
          } else {
              title.textContent = dept;
          }
            div.appendChild(title);

            const countText = document.createElement("div");
            countText.className = "count";
            countText.textContent = `Results: ${count} record${count !== 1 ? "s" : ""}`;
            div.appendChild(countText);

            const table = document.createElement("table");
            let headers = [];

            if (dept === "Domestic Violence Department") {
              headers = [
                "Name",
                "Case Number",
                "Address",
                "Order Type",
                "Hearing Date",
                "Order Status"
              ];

            } else if (dept === "Field Services Department - Civil Intake"
                    || dept === "Field Services Department - Civil Survey"
                    
                    
                    || dept === "Field Services Department - Warrants") {

              headers = [
                "Name",
                "Case Number",
                "Address",
                "Court Document Type",
                "Intake Date",
                "Current Disposition"
              ];
            } 
              else if (dept === "Fsdw") {
              headers = [
                  "Name",
                  "Case Number",
                  "Address",
                  "Type",
                  "Intake Date",
                  "Status"
              ];
          }
              else if (dept === dept === "Field Services Department - Civil" ||
                    dept === "Field Services Department") {

              headers = [
                
                "Defendant Name",
                "Case Number",
                "Address",
                "Event Date",
                "Event Type"
              ];
            
              
            } else if (dept === "Warrants") {

              headers = [
                "Name",
                "SID",
                "Case Number",
                "Address",
                "Warrant Type",
                "Issue Date",
                "Warrant Status"
              ];

            }

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            headers.forEach(h => {
              const th = document.createElement("th");
              th.textContent = h;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            rows.forEach(row => {

              
              const tr = document.createElement("tr");

              headers.forEach(h => {
                const td = document.createElement("td");

                if (h === "Name") {
                  td.classList.add("name-col");
                }

                const key = FIELD_MAP[h] || h;
                td.textContent = row[key] ?? "";
                tr.appendChild(td);
              });

              tbody.appendChild(tr);
          });

            table.appendChild(tbody);

            const wrapper = document.createElement("div");
            wrapper.className = "results-table-wrapper";
            wrapper.appendChild(table);

            div.appendChild(wrapper);
            resultsDiv.appendChild(div);
          }
        } catch (err) {
          console.error(err);
          status.classList.remove("loading");
          status.textContent = "Error occurred during search.";
        }
      }
    </script>

  
  
  </div> 
</body>
</html>
