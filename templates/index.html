<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BSCO Search Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
</head>
<body>
  
  <div class="container">
    <h1>BCSO Search Portal</h1>

    <form id="searchForm" onsubmit="search(event)">
      <input type="text" id="name" name="name" placeholder="Name">
      <input type="text" id="case_number" name="case_number" placeholder="Case Number">
      <input type="text" id="intake_date" name="intake_date" placeholder="Select Date Range">
      <input type="hidden" id="intake_date_hidden" name="intake_date">
      <button type="submit">Search</button>
    </form>

    <!-- ðŸ‘‡ Added status message placeholder -->
    <p id="statusMessage"></p>

    <div id="results"></div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script id="fp-script-v2">
      // Helper function to update both visible + hidden fields
      function updateDateFields(selectedDates) {
        const f = d => d.toISOString().slice(0, 10);
        let val = "";

        if (selectedDates.length === 1) {
          const one = f(selectedDates[0]);
          val = `${one} to ${one}`;
        }
        else if (selectedDates.length === 2) {
            val = `${f(selectedDates[0])} to ${f(selectedDates[1])}`;
        }
        else {
            // No dates selected
            val = "";
        }

        // Hidden field -> backend uses this
        document.getElementById("intake_date_hidden").value = val;

        // Visible field -> user sees this
        document.getElementById("intake_date").value = val;
      }
    
    
    
      flatpickr("#intake_date", {
          mode: "range",
          dateFormat: "Y-m-d",
          allowInput: false,
          onChange: function(selectedDates) {
            updateDateFields(selectedDates);
        },

          onClose: function(selectedDates) {
            updateDateFields(selectedDates);
        }
      });
    </script>
      

    <script>
      async function search(event) {
        event.preventDefault();

        const status = document.getElementById("statusMessage");
        const resultsDiv = document.getElementById("results");

        // Show loading state
        resultsDiv.innerHTML = "";
        status.textContent = "Searching...";
        status.classList.add("loading");

        // Read date from hidden field (always set by flatpickr)
        let d = document.getElementById("intake_date_hidden").value;

        const params = new URLSearchParams({
          name: document.getElementById("name").value,
          case_number: document.getElementById("case_number").value,
          intake_date: d
        });
        try {
          const response = await fetch(`${window.location.origin}/search_all?${params}`);
          const data = await response.json();

          status.classList.remove("loading");

          if (Object.keys(data).length === 0) {
            resultsDiv.innerHTML = "<p>No results found.</p>";
            status.textContent = "No results found.";
            return;
          }

          status.textContent = "Search complete.";

          for (const [dept, info] of Object.entries(data)) {
            const rows = info.records;
            const count = info.count;

            const div = document.createElement("div");
            div.className = "department";

            const title = document.createElement("h2");
            title.textContent = dept;
            div.appendChild(title);

            const countText = document.createElement("div");
            countText.className = "count";
            countText.textContent = `Results: ${count} record${count !== 1 ? "s" : ""}`;
            div.appendChild(countText);

            const table = document.createElement("table");
            let headers = [];

            if (dept === "Domestic Violence Department") {
              headers = [
                "Name",
                "Case Number",
                "Address",
                "Order Type",
                "Hearing Date",   // âœ… use Hearing Date for DV
                "Order Status"
              ];
            } else {
              headers = [
                "Name",
                "Case Number",
                "Address",
                "Court Document Type",
                "Intake Date",    // âœ… keep Intake Date for Civil/FS
                "Current Disposition"
              ];
            }

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            headers.forEach(h => {
              const th = document.createElement("th");
              th.textContent = h;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            rows.forEach(row => {

              
              const tr = document.createElement("tr");

              headers.forEach(h => {
                  const td = document.createElement("td");
                  td.textContent = row[h] || "";
                  tr.appendChild(td);
              });

              tbody.appendChild(tr);
          });

            table.appendChild(tbody);

            div.appendChild(table);
            resultsDiv.appendChild(div);
          }
        } catch (err) {
          console.error(err);
          status.classList.remove("loading");
          status.textContent = "Error occurred during search.";
        }
      }
    </script>

  
  
  </div> 
</body>
</html>
